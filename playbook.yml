---
- name: Setup Web Servers (Nginx + frontend)
  hosts: web
  become: true
  gather_facts: true

  tasks:
    - name: Install Nginx
      yum:
        name: nginx
        state: present

    - name: Start and enable Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes

    - name: Ensure git is installed
      yum:
        name: git
        state: present

    - name: Clone GroupAFruits-Veg-Market-One repo
      git:
        repo: 'https://github.com/ahmedwoye/GroupAFruits-Veg-Market-One.git'
        dest: /home/ec2-user/GroupAFruits
        version: main
        force: yes
        update: yes

    - name: Replace Nginx default index.html with frontend index.html
      copy:
        src: /home/ec2-user/GroupAFruits/frontend/index.html
        dest: /usr/share/nginx/html/index.html
        owner: root
        group: root
        mode: '0644'
        backup: yes

---

- name: Setup App Servers (Java + Maven + repo)
  hosts: app
  become: true
  gather_facts: true

  tasks:
    - name: Install Java 17
      yum:
        name: java-17-amazon-corretto
        state: present

    - name: Install Maven
      yum:
        name: maven
        state: present

    - name: Ensure git is installed
      yum:
        name: git
        state: present

    - name: Clone GroupAFruits-Veg-Market-One repo
      git:
        repo: 'https://github.com/ahmedwoye/GroupAFruits-Veg-Market-One.git'
        dest: /home/ec2-user/GroupAFruits
        version: main
        force: yes
        update: yes

    - name: Verify Java installation
      command: java -version
      register: java_version
      changed_when: false

    - name: Show installed Java version
      debug:
        msg: "{{ java_version.stdout }}"

    - name: Verify Maven installation
      command: mvn -version
      register: maven_version
      changed_when: false

    - name: Show installed Maven version
      debug:
        msg: "{{ maven_version.stdout }}"
    
    - name: Clone GroupAFruits-Veg-Market-One repo
      git:
        repo: 'https://github.com/ahmedwoye/GroupAFruits-Veg-Market-One.git'
        dest: /home/ec2-user/GroupAFruits
        version: main
        force: yes
        update: yes
